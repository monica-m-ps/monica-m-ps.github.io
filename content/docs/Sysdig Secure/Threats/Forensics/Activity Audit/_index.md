---
linkTitle: "Activity Audit"
title: "Activity Audit"
weight: "10"
aliases:
  - /en/activity-audit.html
  - /en/activity-audit
  - /en/docs/sysdig-secure/investigate/activity-audit/
description: "Activity Audit surveils interactive commands, established connections, file activities, and `kube exec` requests to the Kubernetes API. This makes them searchable and indexed against your cloud-native assets."
---

## Prerequisites

- To track `kubectl exec` and other Kubernetes commands, [Install Kubernetes audit logging](/en/install-audit-logging/).

- If you are running on a GKE cluster, review [GKE Limitations](/en/docs/sysdig-secure/install-agent-components/install-agent-components/kubernetes/install-kubernetes-audit-logging/#gke-limitations).

## Access Activity Audit

To access Activity Audit:

1. Log in to Sysdig Secure.

2. Select **Threats** > **Forensics** | **Activity Audit**.

## Understand Activity Audit

Use Activity Audit to view different data sources in-depth for monitoring, troubleshooting, diagnostics, or to meet regulatory controls.

### Investigate Events

A system investigation might be triggered by an event generated by Sysdig,
or by an alert from another tool or person.

- **Find contextualized, relevant data** - Activity Audit enables you to easily
    access to the underlying data to help trace the event, evaluate its
    impact, and resolve the issue.

    **From Policy Events in Sysdig Secure**, go directly to the
    relevant Activity Audit to investigate details.

- **Trace commands and connections back to users** Activity Audit can
    correlate interactive requests from a Kubernetes user with the
    commands and network connections performed inside the container,
    enabling an operator to trace this activity back to a user identity.

### Use Activity Audit for Regulatory Audits

Activity Audit can also provide data about the infrastructure to
help prove to auditors that proper data visibility and security measures
are in place.

Activity Audit is a critical requirement for many compliance standards:

- [SOC2](https://us.aicpa.org/interestareas/frc/assuranceadvisoryservices/sorhome.html)

- [PCI](https://www.pcisecuritystandards.org/)

- [HIPAA](https://www.totalhipaa.com/stay-hipaa-compliant-audit-logs)

- [NIST 800-53](https://nvd.nist.gov/800-53/Rev4/control/AU-3)

## Navigate the Audit Interface

Activity Audit displays a continuously updated list of activities. Use
the UI features to find and filter the information you need.

Select **Threats** > **Forensics**|**Activity Audit** to view the Audit Interface.

### Filter Activities

Filtering is the heart of Activity Audit's power. You can use filters to search, sort, parse, and surface meaningful data and connections.

**Ways to filter Activity Data:**

- **Scope:** Reduce the scope of your investigation by focusing on a more specific area of your infrastructure.
    By default, your scope will be set to `Everywhere`, unless a team scope is defined for your currently selected team.

- **Data Source:** Choose a data source from the right side of the graph.
    Currently available data sources are:
    `network activity`, `commands`, `kubectl exec`, or `file`.
    You can also select more than one source.

- **Attribute (=/!=):** Choose **=** or **-!=** next to an attribute, either from the list or from the detail view,
    to include/exclude that attribute from the filter

- **Attribute (manual):** If you know the attribute, you can type it
    into the filter box manually, with the following syntax:

    *Include an attribute*

    `attribute_name="attribute_value"` e.g. `comm="grep"`

    *Exclude an attribute*

    `attribute_name!="attribute_value"` e.g. `comm!="grep"`

- **Trace** Trace entries to see all relevant activity in
    a session from a specific user.
    See the [Trace Button paragraph](#trace-button-for-kube-exec-and-shell-activities) for details.

- **Frequency graph:** Select a section of the graph to zoom in on a time
    frame and see detailed activity. For details, see [Frequency Graph paragraph](#frequency-graph).

- **Combine:** You can combine these methods as needed.

    For example, the following filter surfaces activity on a particular pod,
    while excluding activity from one IP address that is known to be
    normal.

    `resource="pods" name="woocommerce-6877958" sourceaddresses!="172.20.41.2`

### Frequency Graph

The graph shows the activity frequency for each data source, letting you easily zero-in on anomalies.

![](/image/audit_spike.png)

The image above shows a spike in network activity (purple line) between
12:00 - 3:00 pm.

Drag the mouse over the peak to auto-zoom on the time frame and see more
detail.

![](/image/audit_spike_detail.png)

### Data Sources

Use the legend at the right side of the graph to filter information from one particular data set. The currently available data sources are:

- User commands (interactive commands tracked by Activity Audit when a user has logged in and is interacting with the shell via SSH or console login)

- Kube exec commands (extracted from the [Kubernetes/OpenShift audit log](/en/docs/sysdig-secure/threats/forensics/kubernetes-audit-logging/))

- Network connections and file activities related to user and Kube/Docker exec commands

{{% callout type="note" %}}

Activity Audit captures *interactive commands* and the network connections and file modifications related to those commands. `Interactive` means that the `tty` for the process is not `0`.  It also logs connections made to and from sshd and telnet.

{{% /callout %}}

### Time Navigation Buttons

Use the time window navigation bar to show only activities run within that window.

### Activity Row and Details

Select an activity row to see its details on the right panel, including all the collected attributes. You can use attributes to quickly add filters including `=` or excluding `!=` such a value.

See [Review Activity Details](#review-activity-details) for the attributes of each data source.

![](/image/aa_filter.png)

You can also perform quick filtering by selecting attribute and filter type directly from the activity row.
![](/image/aa_row_filter.png)

#### Trace Button for kube exec and Shell Activities

Beside each activity originating a trace there is a Trace button
![](/image/trace_button.png).
The Trace button is only available for the following events:

- kube exec
- kube attach
- ssh
- dropbear
- shells (*sh)

The Trace button lets you correlate activities from the originator to each single performed operation.
See [Follow a kubectl exec Trace use case](#follow-a-kubectl-exec-trace) to see it in action.

This button does not appear if you are running on a GKE cluster.

#### kubectl run

The Kubernetes event in the activity audit list labeled *kube run* is received from the AC in the following cases:

- A kubectl run is performed
- A kubectl attach is performed

## Review Activity Details

**Command Details**

<table>
<thead>
<tr class="header">
<th><p>Name</p></th>
<th><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Time</p></td>
<td><p>The date and time the command was executed.</p></td>
</tr>
<tr class="even">
<td><p>Command</p></td>
<td><p>The command executed.</p></td>
</tr>
<tr class="odd">
<td><p>Full Command Line</p></td>
<td><p>The complete command, including all variables/options.</p></td>
</tr>
<tr class="even">
<td><p>Working Directory</p></td>
<td><p>The directory the command was executed in.</p></td>
</tr>
<tr class="odd">
<td><p>Scope</p></td>
<td><p>The entities within the infrastructure impacted by the command, including</p>
<ul>
<li><p>Kubernetes namespace name</p></li>
<li><p>Kubernetes deployment name</p></li>
<li><p>Kubernetes cluster name</p></li>
<li><p>Kubernetes pod name</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p>Host</p></td>
<td><p>The hostname and MAC address of the host the command was executed on.
The hostname value is expected to match <code>/proc/sys/kernel/hostname</code> contents of the host or container. </p></td>
</tr>
<tr class="odd">
<td><p>Additional Details</p></td>
<td><p>Detailed user/host information:</p>
<ul>
<li><p>The Process ID (PID) of the command.</p></li>
<li><p>The Parent Process ID (PPID) of the command.</p></li>
<li><p>The user ID of the user that executed the command.</p></li>
<li><p>The Shell ID.</p></li>
</ul></td>
</tr>
</tbody>
</table>

**Network Connection Details**

{{% callout type="note" %}}
Only `TCP` connections are currently captured in activity audit.

{{% /callout %}}

<table>
<thead>
<tr class="header">
<th><p>Name</p></th>
<th><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Time</p></td>
<td><p>The date and time of the network connection</p></td>
</tr>
<tr class="even">
<td><p>Connection Direction</p></td>
<td><p>Incoming or outgoing connection</p></td>
</tr>
<tr class="odd">
<td><p>Connection Details</p></td>
<td><p>Including:</p>
<ul>
<li><p>Transport-level protocol (lp4)</p></li>
<li><p>Client address, server address (lp4)</p></li>
<li><p>Client port, server port</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p>Scope</p></td>
<td><p>The entities impacted by the network connection, including</p>
<ul>
<li><p>Kubernetes namespace name</p></li>
<li><p>Kubernetes cluster name</p></li>
<li><p>Kubernetes pod name</p></li>
</ul></td>
</tr>
<tr class="odd">
<td><p>Host</p></td>
<td><p>The host name and MAC address of the host where the connection was made</p></td>
</tr>
<tr class="even">
<td><p>Additional Details</p></td>
<td><p>The process name and ID (Parent Process ID/PID) that launched or received the network connection</p></td>
</tr>
</tbody>
</table>

**Kubectl Exec Details**

<table>
<thead>
<tr class="header">
<th><p>Name</p></th>
<th><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Time</p></td>
<td><p>The date and time of the kubectl command</p></td>
</tr>
<tr class="even">
<td><p>Kubernetes resource</p></td>
<td><p>Including:</p>
<ul>
<li><p>resource: The kind of Kubernetes resource affected (currently only pods)</p></li>
<li><p>name: name of the resource (pod name)</p></li>
<li><p>subresource: currently exec</p></li>
<li><p>command: the command executed</p></li>
<li><p>container: the high-level name in the Kubernetes definition</p></li>
</ul></td>
</tr>
<tr class="odd">
<td><p>Kubernetes user and group</p></td>
<td><p>Including:</p>
<ul>
<li><p>user: user name performing the kubectl command. Can be either a service account or a human user.</p></li>
<li><p>groups: groups the user belongs to</p></li>
<li><p>userAgent: client userAgent</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p>Sources addresses</p></td>
<td><p>External IP address that initiated the connection</p></td>
</tr>
<tr class="odd">
<td><p>Scope</p></td>
<td><p>Including</p>
<ul>
<li><p>Kubernetes namespace name</p></li>
<li><p>Kubernetes deployment name</p></li>
<li><p>Kubernetes cluster name</p></li>
<li><p>Kubernetes pod name</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p>Host</p></td>
<td><p>Host name and MAC address of the host where the kubectl exec was made</p></td>
</tr>
</tbody>
</table>

**File Activity Details**

<table>
<thead>
<tr class="header">
<th><p>Name</p></th>
<th><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Time</p></td>
<td><p>Date and time the file was modified</p></td>
</tr>
<tr class="even">
<td><p>File access details</p></td>
<td><p>- File name</p>
<p>- File directory</p>
<p>- Command used to access the file</p>
<p>- Access mode</p></td>
</tr>
<tr class="odd">
<td><p>Scope</p></td>
<td><p>Entities impacted by the file activity, including</p>
<ul>
<li><p>Kubernetes namespace name</p></li>
<li><p>Kubernetes deployment name</p></li>
<li><p>Kubernetes cluster name</p></li>
<li><p>Kubernetes pod name</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p>Host</p></td>
<td><p>The host name and MAC address of the host where the file activity occurred</p></td>
</tr>
</tbody>
</table>

## Use Cases

### Look for Suspicious Commands

During an investigation you usually need to find suspicious activities
among the most normal and recurring ones.

In this example, a `ps` command is executed very frequently,
being noisy and making investigations harder.

To focus on other, more suspicious commands, you can use filters
to reduce noise and make the investigation easier.
![](/image/aa_blacklist_commands_1.png)

You can use quick filters to exclude the `ps` command,
so that other more interesting commands emerge instantly.
![](/image/aa_blacklist_commands_2.png)

### Filtering for Incident Response

A Policy Event reports a dangerous peak in network connections coming
from a specific pod. This example describes one way to search for the
root cause.

What user and what activity triggered this issue?

1. Use the **Respond** button next to the policy event to jump directly to the relevant data.

2. Here you can determine at a glance:

    - The pod/namespace on which the heightened activity is occurring.

    - The process related to the activity (in this case, `ab`, or the
        Apache Benchmark tool).

    - Related activities in the graph (`cmd` and `kube exec` lines).

    - Repetitive entries that can be screened out.

3. Refine the view through filtering:

    1. Switch from `network` data source to `cmd` and `kube exe`.

    2. Filter out noisy, repetitive entries (such as `comm!="bash"`)

    3. Investigate details of a kube exec item for user information.

    ![](/image/new_aa3.png)

4. After filtering, you have a focused incident report detailing:

    - The Kubernetes user "johndoe"

    - The external IP he used to connect

    - The set of commands he used to install and launch the Apache
        Benchmark stress-testing tool.

#### Follow a kubectl exec Trace

In a production environment, `kubectl exec` commands are typically
suspicious. Also, because such commands are interactive sessions, it can
be difficult to pinpoint which individual has issued the commands and
what other activities the individual performed. You can use Sysdig's
Trace functionality to correlate kubectl exec commands with a
specific user and the network and command activities performed in that
user's session.

In this example, suspicious activity has been detected and you want to
determine whether someone has downloaded and executed a Trojan horse.

1. Use the Groups to display your Kubernetes hierarchy by namespace and
    deployment. Focus on the pod displaying unexpected high levels of
    activity (based on the number in parentheses).

2. Check the corresponding activity graph and zero in on a time
    frame and see `kube exec` activity among the hundreds of commands
    and network events.

    ![](/image/trace2.png)

3. Select the `kube exec` item and click the **Trace** button on left.

    This session trace displays a formatted report of any container
    activity (network, commands) that the user performed inside the
    container.

    ![](/image/trace3.png)

{{% callout type="note" %}}
This button does not appear if you are running on a GKE cluster.
{{% /callout %}}
